Концепция
=========
* User.
* Регистрация.
* Тесты, Планировщик, Финансы.
* Контакты (для уведомлений: e-mail, sms, jabber).
* На хосте может быть несколько модулей node. Каждый находится в отдельном пользователе.
* Статистика агрегируется по часам. В идеале выбрать максимальный интервал, например по дням, но в разных временных зонах день начинается в разное время.
* Статистика удаляется после 42 дней. Максимальное количество записей - 1008 (42*24) - приемлемо.
* Код выносить в отдельные функции/модули только для устранения дублирования.
* Денег брать по рублю за Test Action. Можно и по центу, но лучше по рублю, т.к. рубль дороже а выглядит дешевле.
* При блокировании аккаунта:
 1. изенить пароль на случайный
 2. изменить логин на случайный
 3. удалить E-Mail (если есть)
 4. удалить все задачи расписания
 5. отменить все подписки и транзакции в биллинге
 6. сделать refund по размеру баланса
 6. списать остаток баланса (для последующего удаления аккаунта из БД, после полного refund остаток содержит только бонусы)
 7. отменить все задачи в очереди на выполнение
 8. удалить тесты (пометить как удаленные, для удаления аккаунта когда они зачистятся из БД)
* Основной код лежит в каталогах advanced_web_testing и web_construction_set, из ai/ ui/ si/ он вызывается. Это упрощает обновления.
* Таймаут для теста и test action. Если тест выполняется более таймаута то он перезапускается. Тест в состоянии выполнения
 можно отменить после суммы таймаутов для test action. Отдельный таймаут для каждого теста не эффективно (нужно будет регулярно перебирать
 все тесты). По этому возникает максимальное количество test action.
* Именование хостов:  
sX.hosts.advancedwebtesting.com - сеовер (веб-интерфейс)  
cX.hosts.advancedwebtesting.com - клиент (task executor)  
pX.hosts.advancedwebtesting.com - прокси  
nX.hosts.advancedwebtesting.com - general-purpose node  

Удаление неиспользуемых аккаунтов
---------------------------------
*Задача*  
Нужно удалять неиспользуемые аккаунты, читать из БД минимально, доп. SQL (limit, count) не использовать.

Удалять аккаунт с тестами нельзя - пользователь мог пополнить аккаунт и уйти на пол года.
В этом случае как только баланс исчерпается аккаунт сразу-же будет удален.
Только отсутствие транзакций биллинга позволяет выявить неактивность аккаунта.
Но регулярная (каждую минуту из cron) выборка транзакций билинга нарушает условия задачи по работе с БД.

*Решение*  
Добавить time в users.
Поле time - время доступа (login, ch.password).
Удалить данные users если (выполнение всех условий):
* users.time старше purge period
* аккант возможно удалить (undeletable != 1)
* нет E-mail
* нет тестов
* баланс <= 0
* отсутствуют pending transactions
* отсутствуют subscriptions

При выполнении этих условий других данных в системе уже нет (кроме билинга).
Могут остаться транзакции биллинга, но они невозвратные (purge period занесен в terms по возвратам).
stats, tasks, history к этому моменту удалятся (они удаляются с тем-же периодом).
Количество Pending Transactions и Subscriptions невелико, регулярное их вычитывание условия работы с БД не нарушает.

*Проблема*  
Что если есть тесты но аккаунт не используется?

*Решение*  
Смотреть наличие транзакций биллинга, но это нарушает условия работы с БД.

*Другое решение*  
Удалять аккаунты вручную если нет с них дохода.
Вручную проверять наличие транзакций биллинга (это гораздо реже чем из cron).

Вероятно имеет смысл применить оба решения.

[Task Types](task_types.md)  
[Action Types](action_types.md)  
